name: "Deploy to production"

on:
  push:
    branches:
      - "devops/deploy-to-production"
  workflow_dispatch:

jobs:
  deploy-to-production:
    runs-on: "ubuntu-latest"
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        environment: ["primary"]
    concurrency:
      group: "deploy-to-production-${{ matrix.environment }}"
      cancel-in-progress: true
    env:
      COMPOSE_DOCKER_CLI_BUILD: 1
      COMPOSE_PROJECT_NAME: "deploy-to-production-${{ matrix.environment }}"
      DOCKER_BUILDKIT: 1
    steps:
      - name: "Checkout everything"
        uses: "actions/checkout@v3"
        with:
          fetch-depth: 0
          token: ${{ secrets.CHECKOUT_ACTION_PAT }}

      - name: "Init git config"
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'bornasepic98@gmail.com'
        # Workaround for No TTY issue
        shell: 'script -qec "bash {0}"'

      - name: "Build and start `devops_cd` container"
        run: |
          git fetch --all \
            && touch .env \
            && docker compose build \
                --build-arg GROUP_ID=$(id -g) --build-arg USER_ID=$(id -u) \
                --progress=plain devops_cd \
            && docker compose up -d devops_cd
        shell: 'script -qec "bash {0}"'

      - name: "Deploy to production"
        run: |
          docker compose exec devops_cd ./docker-entrypoint.sh ./ci/deploy-to-production.sh \
            && git push --all origin \
            && echo 'Deployed to production successfully'
        shell: 'script -qec "bash {0}"'

      - name: "Shutdown containers"
        run: |
          docker compose ps \
            && docker compose stop --timeout=30 \
            && docker network inspect "${COMPOSE_PROJECT_NAME}_cd" \
            && docker compose down
        shell: 'script -qec "bash {0}"'
